name: End-to-end tests
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]
jobs:
  # Label of the container job
  container-job:
    # Containers must run in Linux based operating systems
    runs-on: ubuntu-latest

    steps:
      # Downloads a copy of the code in your repository before running CI tests
      - name: Check out repository code
        uses: actions/checkout@v3

      - name: Start docker containers
        run: |
          docker-compose up --build --detach
          sleep 10  # wait for database to be ready
          docker-compose run web bash -c "rails db:create db:migrate db:seed"

      - name:  Run backend unit and integration tests
        run: |
          docker-compose run web rspec -f j -o tmp/rspec_results.json -f p
          docker cp medal-creator-web-1:/usr/src/app/tmp/rspec_results.json .
          tail -n +3 rspec_results.json > rspec_output.json

    
      - name: RSpec Report
        uses: SonicGarden/rspec-report-action@v2
        with:
          token: ${{ github.token }}
          json-path: rspec_output.json
        if: always()

      # - name: Cypress run
      #   env:
      #     NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      #   uses: cypress-io/github-action@v4
      #   with:
      #     working-directory: front
      #     build: npm run build
      #     start: npm run start
      #     wait-on: http://localhost:3000

      # - name: Run cypress e2e tests
      #   uses: cypress-io/github-action@v4
      #   with:
      #     working-directory: front
      #     wait-on: "http://localhost:3000"

      # - name: "Upload screenshots to Slack"
      #   uses: trymbill/cypress-slack-video-upload-action@v1.3.0
      #   if: failure()
      #   with:
      #     token: ${{ secrets.SLACK_TOKEN }}
      #     workdir: front/cypress
      #     channels: "dev-process"
      #     message-text: "Cypress tests failed! They have been placed in this thread, good luck."


